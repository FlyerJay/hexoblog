---
title: HTTP-浏览器缓存
date: 2017-08-10 10:59:48
tags: 'http'
---
### 前言
&#8195;&#8195;浏览器缓存一直是困扰前端的一个大问题，有时候我们在服务器上发布了网站的新版本，而客户端的浏览器访问到的依然是旧版本。我们没有办法要求客户强制刷新以体验新版本。所以我们在搭建自己的网站之前认真了解一下浏览器的缓存机制是十分有必要的。
### 什么是浏览器缓存？
&#8195;&#8195;为了节约网络的资源加速浏览，浏览器在用户磁盘上对最近请求过的文档进行存储，当访问者再次请求这个页面时，浏览器就可以从本地磁盘显示文档，这样就可以加速页面的阅览。浏览器缓存除了要受到浏览器本身缓存策略的控制，还需要根据HTTP设置做出响应。本文的目的是介绍HTTP设置对浏览器缓存的影响，即使通常浏览器并不把这些设置暴露给用户。
### Cache-Control
&#8195;&#8195;还记得用chrome调试网页的经历吗？为了保证调试的时候总是取到最新的代码，我们往往会勾上Network中的Disable cache选项。![](/snow/uploads/http-浏览器缓存-1.png)但是你们有注意过勾上这一项之后到底发生了什么变化吗？
未勾选Disable cache时的资源请求
![](/snow/uploads/http-浏览器缓存-2.png)勾选Disable cache之后![](/snow/uploads/http-浏览器缓存-3.png)chorme发起http请求的时候Cache-control的值被默认设置为：max-age=0。max-age的取值如果大于等于0表示缓存多久之后去服务器请求新的资源，如果我们设置为100，那么在100秒内访问这个资源都不会去请求服务器而是从本地缓存拿。勾选Disable cache之后Cache-control的值被设置为no-cache，意味本地不缓存该资源，每次都去服务器拿最新的。Cache-Control还有一些其他的取值，但是在浏览器上一般就用到介绍的这两个值。（HTTP协议不只是针对客户端浏览器，还包括所有使用该协议的其他终端如代理、服务器等）
### Expires
&#8195;&#8195;Expires也是用来控制浏览器缓存的，同Cache-Control作用一样，但是Expires设置的是一个确切的时间，比如把Expires设置为2017-08-11 08:00:00，缓存的资源就会在这个时间到来的时过期。Expires和Cache-Control的区别就在于一个是相对的时间，另一个是绝对的时间。Cache-Control是较新的HTTP/1.1规范，如果同时设置Expires和Cache-Control，Expires会被Cache-Control所覆盖。
### 服务器再验证
&#8195;&#8195;如果缓存资源过期浏览器就需要向服务器发起请求，但是这个请求并不是直接向服务器请求新的资源，而是希望服务器告知过期的资源是不是需要更新，如果需要更新浏览器就拉取新的资源并更新缓存，如果不需要更新浏览器就重新设置过期时间并继续使用原来的资源返回给用户，这一过程被称为缓存的再验证。
### If_Modified_Since（下面简称IMS）
&#8195;&#8195;HTTP为缓存再验证提供了5种设置，IMS是比较常用的设置，其值为一个确切的时间点，浏览器发送的再验证请求会带上这个设置去服务器询问在这个日期之后资源是否发生过变化，如果有变化服务器就会把新的资源发送过来并带上新的过期时间。IMS的值一般是资源最后被修改的时间。IMS经常配合Last_Modified使用，Last_Modified是服务器维护的资源最后被修改的时间，包含IMS的HTTP请求到服务器之后，服务器会比对请求资源的Last_Modified和IMS。
### If_None_Match（下面简称INM）
&#8195;&#8195;有的时候单纯比较文档的更新时间并不十分科学，比如服务器上的资源只是被重写一次，或者更糟的情况是这个资源会周期性的被重写但是什么内容都没有改变，如果使用IMS验证得到的答案都是需要更新浏览器缓存。为了应对这种情况，服务器除了维护一个资源更新时间以外还会维护一个ETag来标志资源的版本号，只有资源内容被修改后才会更新ETag。浏览器如果想要实现与服务器的ETag进行比对，需要在再验证请求头种携带INM，服务器发现这个设置之后就会比对缓存的ETag和服务器的ETag，如果不同就新的资源及ETag回送到浏览器。IMS和INM同时使用时，会优先验证INM。
>   本文中提到的设置一词均是指HTTP首部字段的配置，希望不会产生歧义。如果对HTTP缓存机制还意犹未尽的朋友可以看看《HTTP权威指南》一书，书中有提到如何实践缓存控制，或者看看以下博客：
>   [Web 开发人员需知的 Web 缓存知识](http://www.oschina.net/news/41397/web-cache-knowledge)
>   [浏览器缓存详解:expires,cache-control,last-modified,etag详细说明](http://blog.csdn.net/eroswang/article/details/8302191)